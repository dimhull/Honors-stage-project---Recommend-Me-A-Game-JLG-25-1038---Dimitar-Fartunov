@page "/"
@rendermode InteractiveServer
@using BlazorApp1.Components.Models
@using BlazorApp1.Components.Service
@inject RawgApiService ApiService
@inject GameRecommendationService RecommendationService

<PageTitle>Game Recommender</PageTitle>

<div class="home-container">
    <header class="hero">
        <h1>Game Recommender</h1>
        <p>Find your next favorite game based on what you love</p>
    </header>

    <div class="search-section">
        <SearchBar OnGameSelect="HandleGameSelected" />
    </div>

    @if (selectedGame != null)
    {

            @if (selectedGame != null)
            {
                <section class="selected-game-section">
                    <h2>Selected Game</h2>
                    <button @onclick="GoBackHome">← Back to Home</button>
                    <div class="selected-game">
                        <GameCard Game="selectedGame" />
                    </div>
                </section>
            }
    }

    @if (isLoadingRecommendations)
    {
        <div class="loading">
            <div class="spinner">🔄</div>
            <p>Finding similar games...</p>
        </div>
    }

    @if (recommendations.Any())
    {
        <section class="recommendations-section">
            <h2>Recommended Games</h2>
            <div class="games-grid">
                @foreach (var rec in recommendations)
                {
                    <GameCard Game="rec.Game"
                              ShowSimilarityScore="true"
                              SimilarityScore="rec.SimilarityScore"
                              OnClick="HandleGameSelected" />
                }
            </div>
        </section>
    }

    @if (popularGames.Any() && !recommendations.Any() && selectedGame == null)
    {
        <section class="popular-section">
            <h2>Popular Games</h2>
            <div class="games-grid">
                @foreach (var game in popularGames)
                {
                    <GameCard Game="game" OnClick="HandleGameSelected" />
                }
            </div>
        </section>
    }
</div>

@code {
    private Game? selectedGame;
    private List<GameRecommendation> recommendations = new();
    private List<Game> popularGames = new();
    private bool isLoadingRecommendations = false;

    protected override async Task OnInitializedAsync()
    {
        // Load popular games for the homepage
        popularGames = await ApiService.GetPopularGamesAsync(12);
    }
    private void GoBackHome()
    {
        selectedGame = null;
        recommendations.Clear();
    }

    private async Task HandleGameSelected(Game game)
    {
        selectedGame = game;
        recommendations.Clear();
        isLoadingRecommendations = true;

        try
        {
            var fullGame = await ApiService.GetGameByIdAsync(game.Id);

            if (fullGame != null)
            {
                Console.WriteLine($"Loaded game: {fullGame.Name}");
                Console.WriteLine($"Tags count: {fullGame.Tags?.Count ?? 0}");
                Console.WriteLine($"First 5 tags: {string.Join(", ", fullGame.Tags?.Take(5).Select(t => t.Name) ?? new List<string>())}");

                selectedGame = fullGame;
                recommendations = await RecommendationService.GetRecommendationsAsync(fullGame, 12);

                Console.WriteLine($"Got {recommendations.Count} recommendations");
            }
        }
        finally
        {
            isLoadingRecommendations = false;
        }
    }
}